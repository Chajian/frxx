generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 玩家数据表
model XianPlayer {
  uuid                    String   @id @db.VarChar(36)
  name                    String   @db.VarChar(16)
  realm                   String   @default("炼气期") @db.VarChar(32)
  realmStage              Int      @default(1) @map("realm_stage")
  qi                      BigInt   @default(0)
  spiritualRoot           Float    @default(0.5) @map("spiritual_root") @db.Double
  spiritualRootType       String?  @map("spiritual_root_type") @db.VarChar(64)
  comprehension           Float    @default(0.5) @db.Double
  techniqueAdaptation     Float    @default(0.6) @map("technique_adaptation") @db.Double
  spiritStones            BigInt   @default(0) @map("spirit_stones")
  contributionPoints      Int      @default(0) @map("contribution_points")
  skillPoints             Int      @default(0) @map("skill_points")
  playerLevel             Int      @default(1) @map("player_level")
  sectId                  Int?     @map("sect_id")
  sectRank                String   @default("member") @map("sect_rank") @db.VarChar(32)
  lastLogin               BigInt?  @map("last_login")
  createdAt               BigInt?  @map("created_at")
  updatedAt               BigInt?  @map("updated_at")
  breakthroughAttempts    Int      @default(0) @map("breakthrough_attempts")
  successfulBreakthroughs Int      @default(0) @map("successful_breakthroughs")
  activeQi                BigInt   @default(0) @map("active_qi")
  lastFateTime            BigInt   @default(0) @map("last_fate_time")
  fateCount               Int      @default(0) @map("fate_count")

  skills     XianPlayerSkill[]
  equipment  XianPlayerEquipment[]
  skillBinds XianPlayerSkillBind[]

  @@index([sectId], map: "idx_sect")
  @@index([realm], map: "idx_realm")
  @@index([lastLogin], map: "idx_last_login")
  @@map("xian_players")
}

// 玩家功法表
model XianPlayerSkill {
  playerUuid String @db.VarChar(36) @map("player_uuid")
  skillId    String @db.VarChar(64) @map("skill_id")
  skillLevel Int    @default(1) @map("skill_level")

  player XianPlayer @relation(fields: [playerUuid], references: [uuid], onDelete: Cascade)

  @@id([playerUuid, skillId])
  @@index([playerUuid], map: "idx_player")
  @@map("xian_player_skills")
}

// 玩家装备表
model XianPlayerEquipment {
  playerUuid    String @db.VarChar(36) @map("player_uuid")
  slot          String @db.VarChar(32)
  equipmentUuid String @db.VarChar(36) @map("equipment_uuid")

  player XianPlayer @relation(fields: [playerUuid], references: [uuid], onDelete: Cascade)

  @@id([playerUuid, slot])
  @@index([playerUuid], map: "idx_player")
  @@map("xian_player_equipment")
}

// 玩家技能绑定表
model XianPlayerSkillBind {
  playerUuid String @db.VarChar(36) @map("player_uuid")
  slot       Int
  skillId    String @db.VarChar(64) @map("skill_id")

  player XianPlayer @relation(fields: [playerUuid], references: [uuid], onDelete: Cascade)

  @@id([playerUuid, slot])
  @@index([playerUuid], map: "idx_player")
  @@map("xian_player_skill_binds")
}

// 宗门数据表
model XianSect {
  id                  Int     @id @default(autoincrement())
  name                String  @unique @db.VarChar(32)
  description         String? @db.Text
  ownerUuid           String  @map("owner_uuid") @db.VarChar(36)
  ownerName           String  @map("owner_name") @db.VarChar(16)
  level               Int     @default(1)
  experience          BigInt  @default(0)
  sectFunds           BigInt  @default(0) @map("sect_funds")
  sectContribution    Int     @default(0) @map("sect_contribution")
  maxMembers          Int     @default(10) @map("max_members")
  recruiting          Boolean @default(true)
  pvpEnabled          Boolean @default(false) @map("pvp_enabled")
  announcement        String? @db.Text
  residenceLandId     String? @map("residence_land_id") @db.VarChar(128)
  landCenterWorld     String? @map("land_center_world") @db.VarChar(64)
  landCenterX         Float?  @default(0) @map("land_center_x") @db.Double
  landCenterY         Float?  @default(0) @map("land_center_y") @db.Double
  landCenterZ         Float?  @default(0) @map("land_center_z") @db.Double
  lastMaintenanceTime BigInt  @default(0) @map("last_maintenance_time")
  buildingSlotsData   String? @map("building_slots_data") @db.LongText
  createdAt           BigInt? @map("created_at")
  updatedAt           BigInt? @map("updated_at")

  members    XianSectMember[]
  facilities XianSectFacility[]
  warehouse  XianSectWarehouse?

  @@index([name], map: "idx_name")
  @@index([ownerUuid], map: "idx_owner")
  @@index([residenceLandId], map: "idx_residence")
  @@map("xian_sects")
}

// 宗门成员表
model XianSectMember {
  sectId              Int    @map("sect_id")
  playerUuid          String @db.VarChar(36) @map("player_uuid")
  playerName          String @db.VarChar(16) @map("player_name")
  rank                String @default("OUTER_DISCIPLE") @db.VarChar(32)
  contribution        Int    @default(0)
  weeklyContribution  Int    @default(0) @map("weekly_contribution")
  joinedAt            BigInt? @map("joined_at")
  lastActiveAt        BigInt? @map("last_active_at")
  tasksCompleted      Int    @default(0) @map("tasks_completed")
  donationCount       Int    @default(0) @map("donation_count")

  sect XianSect @relation(fields: [sectId], references: [id], onDelete: Cascade)

  @@id([sectId, playerUuid])
  @@index([sectId], map: "idx_sect")
  @@index([playerUuid], map: "idx_player")
  @@map("xian_sect_members")
}

// 宗门设施表
model XianSectFacility {
  sectId       Int     @map("sect_id")
  facilityType String  @map("facility_type") @db.VarChar(32)
  level        Int     @default(1)
  upgradedAt   BigInt? @map("upgraded_at")

  sect XianSect @relation(fields: [sectId], references: [id], onDelete: Cascade)

  @@id([sectId, facilityType])
  @@index([sectId], map: "idx_sect")
  @@index([facilityType, level], map: "idx_type_level")
  @@map("xian_sect_facilities")
}

// 宗门仓库表
model XianSectWarehouse {
  sectId       Int     @id @map("sect_id")
  capacity     Int     @default(54)
  itemsJson    String? @map("items_json") @db.LongText
  lastModified BigInt? @map("last_modified")

  sect XianSect @relation(fields: [sectId], references: [id], onDelete: Cascade)

  @@map("xian_sect_warehouses")
}

// 天劫数据表
model XianTribulation {
  tribulationUuid   String  @id @db.VarChar(36) @map("tribulation_uuid")
  playerUuid        String  @db.VarChar(36) @map("player_uuid")
  type              String  @db.VarChar(32)
  worldName         String  @map("world_name") @db.VarChar(64)
  x                 Float   @db.Double
  y                 Float   @db.Double
  z                 Float   @db.Double
  currentWave       Int     @default(0) @map("current_wave")
  totalWaves        Int     @map("total_waves")
  active            Boolean @default(false)
  completed         Boolean @default(false)
  failed            Boolean @default(false)
  startTime         BigInt? @map("start_time")
  endTime           BigInt? @map("end_time")
  lastWaveTime      BigInt? @map("last_wave_time")
  totalDamageDealt  Float   @default(0) @map("total_damage_dealt") @db.Double
  totalDamageTaken  Float   @default(0) @map("total_damage_taken") @db.Double

  @@index([playerUuid], map: "idx_player")
  @@index([active], map: "idx_active")
  @@map("xian_tribulations")
}
