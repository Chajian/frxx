<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XianCore Bossç®¡ç†ç³»ç»Ÿ - ä»ªè¡¨æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .header-subtitle {
            color: #666;
            font-size: 14px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
        }

        .stat-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-group:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #667eea;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ® XianCore Bossç®¡ç†ç³»ç»Ÿ</h1>
            <p class="header-subtitle">å®æ—¶Bossç®¡ç†å’Œç©å®¶ç»Ÿè®¡ä»ªè¡¨æ¿</p>
        </header>

        <div class="controls">
            <button class="btn btn-primary" onclick="loadDashboard()">åˆ·æ–°æ•°æ®</button>
            <button class="btn btn-primary" onclick="loadBosses()">æŸ¥çœ‹Boss</button>
            <button class="btn btn-primary" onclick="loadPlayerStats()">æŸ¥çœ‹ç©å®¶</button>
            <button class="btn btn-primary" onclick="loadRankings()">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
            <button class="btn btn-danger" onclick="clearCache()">æ¸…ç©ºç¼“å­˜</button>
        </div>

        <div id="message"></div>

        <div class="dashboard">
            <div class="card">
                <div class="card-title">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</div>
                <div class="stat-group">
                    <span class="stat-label">æ€»ç©å®¶æ•°</span>
                    <span class="stat-value" id="totalPlayers">-</span>
                </div>
                <div class="stat-group">
                    <span class="stat-label">æ´»è·ƒBoss</span>
                    <span class="stat-value" id="aliveBosses">-</span>
                </div>
                <div class="stat-group">
                    <span class="stat-label">å‡»æ€Bossæ€»æ•°</span>
                    <span class="stat-value" id="killedBosses">-</span>
                </div>
                <div class="stat-group">
                    <span class="stat-label">æ€»ä¼¤å®³</span>
                    <span class="stat-value" id="totalDamage">-</span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">âš¡ æ€§èƒ½æŒ‡æ ‡</div>
                <div class="stat-group">
                    <span class="stat-label">å¹³å‡å“åº”æ—¶é—´</span>
                    <span class="stat-value" id="avgResponseTime">-</span>
                </div>
                <div class="stat-group">
                    <span class="stat-label">æˆåŠŸç‡</span>
                    <span class="stat-value" id="successRate">-</span>
                </div>
                <div class="stat-group">
                    <span class="stat-label">ç¼“å­˜å‘½ä¸­æ•°</span>
                    <span class="stat-value" id="cacheCount">-</span>
                </div>
                <div class="stat-group">
                    <span class="stat-label">æ€»è¯·æ±‚æ•°</span>
                    <span class="stat-value" id="totalRequests">-</span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ† æ’è¡Œæ¦œ</div>
                <div style="font-size: 14px; line-height: 1.8;">
                    <div><strong>Top 1 å‡»æ€ï¼š</strong> <span id="topKiller">-</span></div>
                    <div><strong>Top 1 ä¼¤å®³ï¼š</strong> <span id="topDamager">-</span></div>
                    <div><strong>Top 1 è´¢å¯Œï¼š</strong> <span id="richestPlayer">-</span></div>
                    <div><strong>æœ€æ´»è·ƒç©å®¶ï¼š</strong> <span id="mostActive">-</span></div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div style="padding: 20px;">
                <h2 style="margin-bottom: 15px;">ğŸ”¥ æœ€è¿‘å‡»æ€çš„Boss</h2>
                <div id="recentKills" style="max-height: 400px; overflow-y: auto;">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <div class="table-container" style="margin-top: 20px;">
            <div style="padding: 20px;">
                <h2 style="margin-bottom: 15px;">ğŸ’ª ç©å®¶ä¼¤å®³æ’è¡Œ</h2>
                <div id="damageRanking" style="max-height: 400px; overflow-y: auto;">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api/v1';

        // è·å–APIæ•°æ®
        async function fetchApi(endpoint) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data.data;
            } catch (error) {
                console.error('API Error:', error);
                showMessage('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
                return null;
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(msg, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.innerHTML = `<div class="${type}">${msg}</div>`;
            setTimeout(() => {
                messageEl.innerHTML = '';
            }, 5000);
        }

        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        async function loadDashboard() {
            const [stats, perf, bossCount, killedCount, totalDamage, recentKills] = await Promise.all([
                fetchApi('/stats/count/total'),
                fetchApi('/management/performance/stats'),
                fetch(`${API_BASE_URL}/bosses/alive`).then(r => r.json()).then(d => d.data.length),
                fetchApi('/bosses/count/killed'),
                fetchApi('/stats/total-damage'),
                fetchApi('/bosses/recent-killed?limit=5')
            ]);

            if (stats !== null) {
                document.getElementById('totalPlayers').textContent = stats || '0';
            }
            if (perf) {
                document.getElementById('avgResponseTime').textContent = (perf.averageResponseTimeMs || 0) + 'ms';
                document.getElementById('successRate').textContent = (perf.successRate || 0).toFixed(2) + '%';
                document.getElementById('totalRequests').textContent = perf.totalRequests || '0';
            }
            if (bossCount) {
                document.getElementById('aliveBosses').textContent = bossCount || '0';
            }
            if (killedCount !== null) {
                document.getElementById('killedBosses').textContent = killedCount || '0';
            }
            if (totalDamage !== null) {
                document.getElementById('totalDamage').textContent = (totalDamage || 0).toFixed(0);
            }

            showMessage('æ•°æ®å·²åˆ·æ–°ï¼', 'success');
        }

        // åŠ è½½Bossæ•°æ®
        async function loadBosses() {
            const bosses = await fetchApi('/bosses/alive');
            if (bosses) {
                const html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Bossåç§°</th>
                                <th>ç±»å‹</th>
                                <th>çŠ¶æ€</th>
                                <th>è¡€é‡</th>
                                <th>æ‰€åœ¨ä¸–ç•Œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bosses.map(boss => `
                                <tr>
                                    <td>${boss.name}</td>
                                    <td>${boss.type}</td>
                                    <td><span class="badge badge-success">${boss.status}</span></td>
                                    <td>${(boss.currentHealth || 0).toFixed(0)}/${(boss.maxHealth || 0).toFixed(0)}</td>
                                    <td>${boss.world}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('recentKills').innerHTML = html;
            }
        }

        // åŠ è½½ç©å®¶æ•°æ®
        async function loadPlayerStats() {
            const players = await fetchApi('/stats/rankings/kills?page=0&size=20');
            if (players && players.content) {
                const html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ç©å®¶åç§°</th>
                                <th>å‡»æ€æ•°</th>
                                <th>æ€»ä¼¤å®³</th>
                                <th>ä½™é¢</th>
                                <th>è´¢å¯Œç­‰çº§</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${players.content.map(player => `
                                <tr>
                                    <td>${player.playerName}</td>
                                    <td>${player.bossKills}</td>
                                    <td>${(player.totalDamage || 0).toFixed(0)}</td>
                                    <td>${(player.balance || 0).toFixed(0)}</td>
                                    <td><span class="badge badge-info">æ™®é€š</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('damageRanking').innerHTML = html;
            }
        }

        // åŠ è½½æ’è¡Œæ¦œ
        async function loadRankings() {
            const kills = await fetchApi('/stats/rankings/kills?page=0&size=1');
            const damage = await fetchApi('/stats/rankings/damage?page=0&size=1');
            const wealth = await fetchApi('/stats/rankings/wealth?page=0&size=1');
            const active = await fetchApi('/stats/active-players?limit=1');

            if (kills && kills.content && kills.content.length > 0) {
                document.getElementById('topKiller').textContent = `${kills.content[0].playerName} (${kills.content[0].bossKills})`;
            }
            if (damage && damage.content && damage.content.length > 0) {
                document.getElementById('topDamager').textContent = `${damage.content[0].playerName} (${(damage.content[0].totalDamage || 0).toFixed(0)})`;
            }
            if (wealth && wealth.content && wealth.content.length > 0) {
                document.getElementById('richestPlayer').textContent = `${wealth.content[0].playerName} (${(wealth.content[0].balance || 0).toFixed(0)})`;
            }
            if (active && active.length > 0) {
                document.getElementById('mostActive').textContent = `${active[0].playerName} (${active[0].totalBattles}æ¬¡)`;
            }
        }

        // æ¸…ç©ºç¼“å­˜
        async function clearCache() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜å—ï¼Ÿ')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/management/cache/clear`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        showMessage('ç¼“å­˜å·²æ¸…ç©ºï¼', 'success');
                    }
                } catch (error) {
                    showMessage('æ¸…ç©ºç¼“å­˜å¤±è´¥: ' + error.message, 'error');
                }
            }
        }

        // åˆå§‹åŒ–åŠ è½½
        window.onload = () => {
            loadDashboard();
            loadBosses();
            loadRankings();

            // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®
            setInterval(loadDashboard, 30000);
        };
    </script>
</body>
</html>
