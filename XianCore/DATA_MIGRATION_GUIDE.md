# XianCore 数据迁移指南

## YML → MySQL 一键迁移工具

本工具提供完整的YML文件到MySQL数据库的数据迁移功能。

---

## 📋 前置条件

### 1. MySQL数据库配置

在 `plugins/XianCore/config.yml` 中配置MySQL连接：

```yaml
database:
  use-mysql: true              # 启用MySQL
  host: localhost             # MySQL主机
  port: 3306                  # MySQL端口
  database: xiancore          # 数据库名
  username: root              # 用户名
  password: password          # 密码
  pool-size: 10               # 连接池大小
```

### 2. 数据库准备

```sql
-- 创建数据库（如果不存在）
CREATE DATABASE IF NOT EXISTS xiancore
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;
```

---

## 🚀 使用步骤

### 步骤 1: 查看迁移信息

```bash
/xiancore migrate --info
```

**输出示例：**
```
========================================
       数据迁移准备信息
========================================
YML文件位置: plugins/XianCore/players
找到文件数: 150 个
总数据大小: 2.5 MB
预计耗时: 约 5 秒

======== 目标数据库 ========
类型: MySQL
状态: 已连接

提示:
- 迁移过程中会自动跳过已存在的数据
- 建议先使用 --dry-run 参数预览
- 迁移不会删除YML文件（作为备份保留）
========================================
```

### 步骤 2: 预览迁移（推荐）

```bash
/xiancore migrate --dry-run
```

此命令会：
- ✅ 扫描所有YML文件
- ✅ 解析玩家数据
- ✅ 生成迁移报告
- ❌ **不会**实际写入数据库

### 步骤 3: 执行真实迁移

```bash
/xiancore migrate confirm
```

**⚠️ 重要提示：**
- 迁移过程中**不要关闭服务器**
- 迁移是**异步**执行的，不会卡服
- YML文件会**保留**作为备份

---

## 📊 迁移报告解读

### 成功迁移报告示例

```
========================================
       数据迁移完成报告
========================================

开始时间: 2025-12-04 21:00:00
结束时间: 2025-12-04 21:00:05
总耗时: 5 秒

======== 统计信息 ========
总文件数: 150
成功迁移: 150
失败数量: 0
跳过数量: 0
成功率: 100.00%
数据大小: 2.50 MB

迁移速度: 30.00 个/秒

========================================
✓ 迁移完全成功！所有数据已安全迁移到MySQL
========================================
```

### 部分失败报告示例

```
======== 错误详情 ========
1. player123.yml (UUID: abc-def-ghi)
   错误: 无法解析YML文件
2. player456.yml (UUID: xyz-uvw-rst)
   错误: 数据格式不兼容
```

---

## 🎯 常见使用场景

### 场景 1: 新服务器迁移

```bash
# 1. 配置MySQL
vim plugins/XianCore/config.yml

# 2. 重启服务器（自动创建表结构）
/stop

# 3. 启动后查看信息
/xiancore migrate --info

# 4. 预览迁移
/xiancore migrate --dry-run

# 5. 执行迁移
/xiancore migrate confirm
```

### 场景 2: 已有部分数据

```bash
# 迁移会自动跳过已存在的数据
/xiancore migrate confirm
```

### 场景 3: 增量迁移

```bash
# 只迁移新增的玩家
# 工具会自动检测并跳过已存在的玩家
/xiancore migrate confirm
```

---

## 🔧 技术细节

### 迁移内容

工具会迁移以下数据：

**玩家数据：**
- UUID和名称
- 境界和境界阶段
- 修为（灵气）
- 灵根类型和值
- 悟性、功法适应性
- 灵石、贡献点
- 等级信息
- 宗门信息
- 天赋数据
- 活跃灵气

**功法数据：**
- 已学习的功法列表
- 功法等级
- 功法绑定槽位

**装备数据：**
- 装备槽位
- 装备UUID

### 数据安全

✅ **原YML文件保留** - 迁移不会删除原文件  
✅ **跳过重复数据** - 避免数据覆盖  
✅ **事务安全** - 失败自动回滚  
✅ **异步执行** - 不影响服务器性能  

### 性能指标

- **迁移速度**：约 10-50 个玩家/秒
- **内存占用**：低（流式处理）
- **服务器影响**：极小（异步执行）

---

## ⚠️ 注意事项

### 迁移前

1. **备份数据库**
   ```bash
   mysqldump -u root -p xiancore > backup.sql
   ```

2. **确保MySQL可用**
   ```bash
   /xiancore migrate --info
   ```

3. **先预览再执行**
   ```bash
   /xiancore migrate --dry-run
   ```

### 迁移中

- ❌ 不要关闭服务器
- ❌ 不要重载插件
- ❌ 不要修改配置

### 迁移后

- ✅ 检查迁移报告
- ✅ 测试玩家登录
- ✅ 验证数据完整性
- ✅ 保留YML备份一段时间

---

## 🐛 故障排除

### 问题 1: MySQL连接失败

**症状：**
```
错误: MySQL未启用或无法连接！
```

**解决：**
1. 检查config.yml配置
2. 确认MySQL服务已启动
3. 测试数据库连接
   ```bash
   mysql -u root -p -h localhost
   ```

### 问题 2: 部分数据迁移失败

**症状：**
```
失败数量: 5
```

**解决：**
1. 查看错误详情
2. 检查YML文件格式
3. 手动修复问题文件
4. 重新执行迁移（会跳过已成功的）

### 问题 3: 迁移速度慢

**优化方案：**
1. 增加连接池大小
   ```yaml
   database:
     pool-size: 20  # 增加到20
   ```
2. 优化MySQL配置
3. 确保服务器性能充足

---

##命令权限

```yaml
permissions:
  xiancore.admin.migrate:
    description: 允许执行数据迁移命令
    default: op
```

---

## 📞 技术支持

如遇问题，请提供：
1. 迁移报告完整输出
2. 服务器日志
3. MySQL版本信息
4. YML文件示例

---

## 📝 版本历史

- **v1.0.0** - 初始版本
  - 支持玩家数据迁移
  - 支持功法数据迁移
  - 支持装备数据迁移
  - 自动跳过重复数据
  - 完整的错误报告

---

**注意：此工具已经过充分测试，但仍建议在迁移前备份数据！**
