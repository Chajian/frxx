package com.xiancore.core.data.migrate;

import com.xiancore.XianCore;
import com.xiancore.core.data.migrate.base.IMigrator;
import com.xiancore.core.data.migrate.migrators.PlayerDataMigrator;
import com.xiancore.core.data.migrate.migrators.SectDataMigrator;

import java.util.*;
import java.util.concurrent.CompletableFuture;

/**
 * 迁移管理器 - 最小化配置版本
 * 只启用玩家和宗门迁移器
 * 
 * 使用方法：
 * 1. 重命名此文件为 MigrationManager.java（备份原文件）
 * 2. 确保已创建 xian_sect_members 表
 * 3. 重新编译插件
 *
 * @author XianCore Team
 * @version 1.0.0
 */
public class MigrationManager {
    
    private final XianCore plugin;
    private final Map<String, IMigrator> migrators = new LinkedHashMap<>();
    
    public MigrationManager(XianCore plugin) {
        this.plugin = plugin;
        registerMigrators();
    }
    
    /**
     * 注册所有迁移器 - 最小化版本
     * 只注册玩家和宗门迁移器
     */
    private void registerMigrators() {
        // 玩家数据迁移器
        registerMigrator("player", new PlayerDataMigrator(plugin));
        
        // 宗门数据迁移器（需要xian_sect_members表）
        registerMigrator("sect", new SectDataMigrator(plugin));
        
        // 如果你有以下数据，可以取消注释并创建对应表：
        // registerMigrator("boss", new BossDataMigrator(plugin));
        // registerMigrator("tribulation", new TribulationDataMigrator(plugin));
        // registerMigrator("fate", new FateDataMigrator(plugin));
    }
    
    /**
     * 注册迁移器
     */
    public void registerMigrator(String type, IMigrator migrator) {
        migrators.put(type, migrator);
        plugin.getLogger().info("§a注册迁移器: §f" + type + " - " + migrator.getName());
    }
    
    /**
     * 获取指定类型的迁移器
     */
    public IMigrator getMigrator(String type) {
        return migrators.get(type);
    }
    
    /**
     * 获取所有迁移器
     */
    public Map<String, IMigrator> getAllMigrators() {
        return new LinkedHashMap<>(migrators);
    }
    
    /**
     * 执行指定类型的迁移
     */
    public CompletableFuture<MigrationReport> migrate(String type, boolean dryRun) {
        return CompletableFuture.supplyAsync(() -> {
            IMigrator migrator = migrators.get(type);
            if (migrator == null) {
                plugin.getLogger().warning("§c未找到迁移器: " + type);
                return new MigrationReport();
            }
            
            plugin.getLogger().info("§e[" + type + "] 开始迁移: " + migrator.getName());
            MigrationReport report = migrator.migrate(dryRun);
            plugin.getLogger().info("§a[" + type + "] " + migrator.getName() + " 迁移完成！");
            
            return report;
        });
    }
    
    /**
     * 执行所有迁移器
     */
    public CompletableFuture<Map<String, MigrationReport>> migrateAll(boolean dryRun) {
        return CompletableFuture.supplyAsync(() -> {
            Map<String, MigrationReport> reports = new LinkedHashMap<>();
            
            plugin.getLogger().info("§b========================================");
            plugin.getLogger().info("§e§l    开始完整数据迁移");
            plugin.getLogger().info("§b========================================");
            plugin.getLogger().info("§e模式: " + (dryRun ? "§6预览模式" : "§c真实迁移"));
            plugin.getLogger().info("§e迁移器数量: §f" + migrators.size());
            plugin.getLogger().info("");
            
            int index = 1;
            for (Map.Entry<String, IMigrator> entry : migrators.entrySet()) {
                String type = entry.getKey();
                IMigrator migrator = entry.getValue();
                
                plugin.getLogger().info("§e[" + index + "/" + migrators.size() + "] 开始迁移: " + migrator.getName());
                
                try {
                    MigrationReport report = migrator.migrate(dryRun);
                    reports.put(type, report);
                    plugin.getLogger().info("§a[" + index + "/" + migrators.size() + "] " + migrator.getName() + " 迁移完成！");
                } catch (Exception e) {
                    plugin.getLogger().severe("§c[" + index + "/" + migrators.size() + "] " + migrator.getName() + " 迁移失败: " + e.getMessage());
                    e.printStackTrace();
                    reports.put(type, new MigrationReport());
                }
                
                plugin.getLogger().info("");
                index++;
            }
            
            // 打印总结
            printSummary(reports);
            
            return reports;
        });
    }
    
    /**
     * 获取迁移前信息摘要
     */
    public String getPreMigrationSummary() {
        StringBuilder sb = new StringBuilder();
        
        sb.append("§b========================================\n");
        sb.append("§e§l       数据迁移准备信息\n");
        sb.append("§b========================================\n\n");
        
        for (Map.Entry<String, IMigrator> entry : migrators.entrySet()) {
            IMigrator migrator = entry.getValue();
            
            if (migrator.hasDataToMigrate()) {
                sb.append("§e▶ ").append(migrator.getName()).append("\n");
                sb.append("  §7").append(migrator.getDescription()).append("\n");
                sb.append("  ").append(migrator.getPreMigrationSummary()).append("\n\n");
            }
        }
        
        sb.append("§e§l提示:\n");
        sb.append("§7- 迁移过程中会自动跳过已存在的数据\n");
        sb.append("§7- 建议先使用 --dry-run 参数预览\n");
        sb.append("§7- 迁移不会删除YML文件（作为备份保留）\n");
        sb.append("§b========================================\n");
        
        return sb.toString();
    }
    
    /**
     * 打印迁移总结
     */
    private void printSummary(Map<String, MigrationReport> reports) {
        plugin.getLogger().info("§b========================================");
        plugin.getLogger().info("§e§l         迁移总结报告");
        plugin.getLogger().info("§b========================================");
        plugin.getLogger().info("");
        
        int totalSuccess = 0;
        int totalFailed = 0;
        int totalSkipped = 0;
        
        for (Map.Entry<String, MigrationReport> entry : reports.entrySet()) {
            String type = entry.getKey();
            MigrationReport report = entry.getValue();
            
            plugin.getLogger().info("§e" + type + ":");
            plugin.getLogger().info("  §a成功: " + report.getSuccessCount() + "  " +
                                   "§c失败: " + report.getFailureCount() + "  " +
                                   "§7跳过: " + report.getSkippedCount());
            
            totalSuccess += report.getSuccessCount();
            totalFailed += report.getFailureCount();
            totalSkipped += report.getSkippedCount();
        }
        
        plugin.getLogger().info("");
        plugin.getLogger().info("§e总计:");
        plugin.getLogger().info("  §a成功: " + totalSuccess + "  " +
                               "§c失败: " + totalFailed + "  " +
                               "§7跳过: " + totalSkipped);
        plugin.getLogger().info("§b========================================");
    }
}
